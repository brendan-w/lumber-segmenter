<!doctype html>

<!--
	Written and Designed by Brendan Whitfield
	because I got sick of doing it by hand...
-->

<html>
	<head>
		<!-- META -->
		<meta charset='utf-8'/>
		<meta name="author" content="Brendan Whitfield">
		<meta name="description" content="Lumber Cut Calculator - A tool for efficiently cutting wood">
		<meta name="keywords" content="lumber, calculator, wood, cut, calculate, layout">
		
		<title>Lumber Segmenter</title>

		<!-- CSS -->
		<style>aside h2,h1{color:#fff;text-transform:uppercase}article,aside,aside table td>*,details,figcaption,figure,footer,header,hgroup,menu,nav,section{display:block}#welcome,aside{text-align:left}a,abbr,acronym,address,applet,article,aside,audio,b,big,blockquote,body,canvas,caption,center,cite,code,dd,del,details,dfn,div,dl,dt,em,embed,fieldset,figcaption,figure,footer,form,h1,h2,h3,h4,h5,h6,header,hgroup,html,i,iframe,img,ins,kbd,label,legend,li,mark,menu,nav,object,ol,output,p,pre,q,ruby,s,samp,section,small,span,strike,strong,sub,summary,sup,table,tbody,td,tfoot,th,thead,time,tr,tt,u,ul,var,video{margin:0;padding:0;border:0;font:inherit;vertical-align:baseline}body{line-height:1;background:#111;color:#888;font-family:Arial,sans-serif;font-size:10pt}ol,ul{list-style:none}blockquote,q{quotes:none}blockquote:after,blockquote:before,q:after,q:before{content:'';content:none}table{border-collapse:collapse;border-spacing:0}body,html{height:100%}html{-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box}*,:after,:before{-webkit-box-sizing:inherit;-moz-box-sizing:inherit;box-sizing:inherit}h1{font-size:14pt;font-weight:700}button,input,select{border:none;background:#111;color:#fff;width:100%;height:25px;font-weight:inherit;font-size:inherit;font-family:inherit}aside h2,button{font-weight:700}button{cursor:pointer}button#run{width:100%;height:50px;background-color:#2B87FF}button#run:hover{background-color:#34ACFF}aside{background:#222;position:absolute;top:0;left:0;width:300px;min-height:100%}aside>section{padding:40px 20px}aside h2{margin-top:45px;margin-bottom:15px}aside h2:first-of-type{margin-top:0}aside table td,aside table th{padding:3px 1px}aside table tr td:first-of-type,aside table tr th:first-of-type{padding-left:0}aside table tr td:last-of-type,aside table tr th:last-of-type{padding-right:0}aside table#settings th{padding-left:10px}aside table input,aside table select{padding:3px}aside button.add{float:right;width:50px;height:100%;font-size:14px}aside button.add:hover{color:#2F2}aside table .color,aside table button.delete{width:25px;height:25px}aside table button.delete:hover{color:#F30}aside table tbody tr:first-of-type button.delete{display:none}ul#output li,ul#output li *{display:inline-block}#main{height:100%;padding:30px 30px 30px 300px;text-align:center}#errors{color:#ff1e1e}ul#output li{padding-top:20px}ul#output li h1{color:#fff;font-size:26px;padding-right:20px;width:4em;text-align:right}#welcome{position:relative;top:50%;-webkit-transform:translateY(-50%);-ms-transform:translateY(-50%);transform:translateY(-50%);margin-left:auto;margin-right:auto;width:300px}#welcome>*{margin-bottom:1em}@media print{aside{display:none}#main{padding:0}ul#output li h1{font-size:20px;color:#000}ul#output li canvas{max-width:580px;height:auto}}</style>

		<!-- JS -->
		<script src="http://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
		<script>var solve={sources:void 0,segments:void 0,used:void 0,kerf:void 0,best_used:void 0,best_loss:void 0,best_clumping:void 0,totalLoss:void 0,run:function(e,s,t){return sources=e,segments=s,used=new Array,kerf=t,best_used=void 0,best_loss=void 0,best_clumping=void 0,this.solve(segments.length-1),totalLoss=best_loss,best_used},solve:function(e){if(e>=0)for(var s=segments[e],t=new Array,r=0;r<sources.length;r++){var n=sources[r],o={length:n.length,numSegs:n.numSegs,segLength:n.segLength};this.inArray(o,t)||(t.push(o),this.remainingSpace(r)>=s.length&&(n.segLength+=s.length,n.numSegs++,used[e]=r,this.solve(e-1),used[e]=-1,n.numSegs--,n.segLength-=s.length))}else{var i=this.totalLoss(),u=this.totalClumping();(void 0===best_loss||i<=best_loss&&u>best_clumping)&&(best_loss=i,best_used=used.slice(0),best_clumping=u)}},totalLoss:function(){for(var e=0,s=0;s<sources.length;s++){var t=sources[s];t.numSegs>0&&(e+=this.remainingSpace(s))}return e},totalClumping:function(){for(var e=0,s=this.totalLoss(),t=0,r=0;r<sources.length;r++){var n=sources[r];n.numSegs>0&&t++}s/=t;for(var r=0;r<sources.length;r++){var n=sources[r];n.numSegs>0&&(e+=Math.abs(s-n.segLength))}return e},remainingSpace:function(e){var s=sources[e];return rem=s.length-(s.segLength+s.numSegs*kerf),rem},inArray:function(e,s){for(var t=0;t<s.length;t++)if(s[t].length===e.length&&s[t].numSegs===e.numSegs&&s[t].segLength===e.segLength)return!0;return!1}},fast_solve_1={sources:void 0,segments:void 0,used:void 0,kerf:void 0,totalLoss:void 0,sourceTypes:void 0,segmentTypes:void 0,run:function(e,s,t){return sources=e,segments=s,used=new Array,kerf=t,sourceTypes=this.compileTypes(sources),segmentTypes=this.compileTypes(segments),this.totalLoss=0,this.solve(),used},solve:function(){for(;this.areMore(segmentTypes)&&this.areMore(sourceTypes);){for(var e=void 0,s=void 0,t=void 0,r=0;r<sourceTypes.length;r++){var n=sourceTypes[r];if(0!=n.indices.length){var o=this.fillPieces(n.length);(void 0===e||o.loss<e)&&(e=o.loss,s=o.pattern,t=r)}}this.totalLoss+=e;for(var i=sourceTypes[t].indices.pop(),r=0;r<s.length;r++){var u=segmentTypes[s[r]].indices.pop();used[u]=i}}!this.areMore(sourceTypes)&&this.areMore(segmentTypes)&&(used=void 0)},fillPieces:function(e){for(var s=new Array,t=0;t<segmentTypes.length;t++)for(var r=segmentTypes[t],n=r.indices.slice(0);0!=n.length&&e>=r.length;)s.push(t),n.pop(),e-=r.length+kerf;return{loss:e,pattern:s}},areMore:function(e){for(var s=0;s<e.length;s++){var t=e[s];if(t.indices.length>0)return!0}return!1},compileTypes:function(e){for(var s=new Array,t=0;t<e.length;t++){var r=e[t],n=this.inArray(r,s);if(-1===n){var o={length:r.length,indices:new Array};o.indices.push(t),s.push(o)}else s[n].indices.push(t)}return s},inArray:function(e,s){for(var t=0;t<s.length;t++)if(s[t].length===e.length)return t;return-1}},fast_solve_2={sources:void 0,segments:void 0,used:void 0,kerf:void 0,totalLoss:void 0,sourceTypes:void 0,segmentTypes:void 0,r_best_loss:void 0,r_best_pattern:void 0,run:function(e,s,t){return sources=e,segments=s,used=new Array,kerf=t,this.totalLoss=0,sourceTypes=this.compileTypes(sources),segmentTypes=this.compileTypes(segments),this.solve(),used},solve:function(){for(;this.areMore(segmentTypes)&&this.areMore(sourceTypes);){for(var e=void 0,s=void 0,t=void 0,r=0;r<sourceTypes.length;r++){var n=sourceTypes[r];0!=n.indices.length&&(r_best_loss=void 0,r_best_pattern=void 0,this.addPiece(n.length,new Array),(void 0===e||r_best_loss<e)&&(e=r_best_loss,s=r_best_pattern,t=r))}this.totalLoss+=e;for(var o=sourceTypes[t].indices.pop(),r=0;r<s.length;r++){var i=segmentTypes[s[r]].indices.pop();used[i]=o}}!this.areMore(sourceTypes)&&this.areMore(segmentTypes)&&(used=void 0)},addPiece:function(e,s){var t=!1;if(e>kerf)for(var r=0;r<segmentTypes.length;r++){var n=segmentTypes[r];if(0!=n.indices.length&&e>=n.length){t=!0;var o=n.indices.pop();s.push(r),this.addPiece(e-(n.length+kerf),s),s.pop(),n.indices.push(o)}}t||(void 0===r_best_loss||e<r_best_loss)&&(r_best_loss=e,r_best_pattern=s.slice(0))},areMore:function(e){for(var s=0;s<e.length;s++){var t=e[s];if(t.indices.length>0)return!0}return!1},compileTypes:function(e){for(var s=new Array,t=0;t<e.length;t++){var r=e[t],n=this.inArray(r,s);if(-1===n){var o={length:r.length,indices:new Array};o.indices.push(t),s.push(o)}else s[n].indices.push(t)}return s},inArray:function(e,s){for(var t=0;t<s.length;t++)if(s[t].length===e.length)return t;return-1}},segmenter={run:function(e,s,t,r,n){for(var o=[],i=0;i<t.length;i++)o.push(this.makeSource(t[i].length));for(var i=0;i<r.length;i++)o.push(this.makeSource(r[i].length));var u=this.test(o,n);if(u.tooBig)return this.makeResult(!1,"One of your desired cuts is too big for any of your stock");if(0===r.length){if(u.tooMuch)return this.makeResult(!1,"You don't have enough wood for that :(")}else for(var i=0;i<r.length;i++){var l=r[i].length,h=Math.ceil(u.maxLoss/l);u.tooMuch&&(h+=Math.ceil(u.howMuchMore/l));for(var a=0;h>a;a++)o.push(this.makeSource(l))}o.sort(function(e,s){return s.length-e.length}),n.sort(function(e,s){return s.length-e.length});var g=void 0;switch(e){default:case"auto":if((t.length+r.length)*n.length<35)g=solve.run(o,n,s);else{var c=fast_solve_1.run(o,n,s),v=fast_solve_1.totalLoss,f=fast_solve_2.run(o,n,s),d=fast_solve_2.totalLoss;g=d>=v?c:f}break;case"solve":g=solve.run(o,n,s);break;case"fast_1":g=fast_solve_1.run(o,n,s);break;case"fast_2":g=fast_solve_2.run(o,n,s)}if(void 0===g||0===g.length)return this.makeResult(!1,"Can't do it :(");var p=this.compileResults(o,n,g);return this.makeResult(!0,p)},compileResults:function(e,s,t){for(var r=new Array,n=0;n<e.length;n++)r[n]={length:e[n].length,segments:new Array,segLength:0};for(var n=0;n<t.length;n++){var o=r[t[n]];o.segments.push(s[n]),o.segLength+=s[n].length}for(var n=0;n<r.length;n++)0==r[n].segments.length&&(r.splice(n,1),n--);return r.sort(function(e,s){return s.segLength-e.segLength}),r},test:function(e,s){for(var t=0,r=0,n=0,o=0,i=0,u=0;u<e.length;u++){var l=e[u].length;o+=l,l>t&&(t=l)}for(var u=0;u<s.length;u++){var l=s[u].length;i+=l,l>r&&(r=l)}return n=i/s.length,{tooBig:r>t,tooMuch:i>o,howMuchMore:i-o,maxLoss:(t-n)*s.length}},makeSource:function(e){return{length:e,numSegs:0,segLength:0}},makeResult:function(e,s){return{success:e,data:s}}};</script>
		<script>function color_for_index(t){var e=282*t;return e=mod(e,360),{"background-color":"hsl("+e.toString()+", 100%, 65%)"}}function selectIndex(t){for(var e=t.val(),r=t.find("option"),n=0;n<r.length;n++)if(r[n].innerHTML===e)return n;return-1}function parse_compound_float(t){var e=parseFloat(t);if(!isNaN(e)){t.replace("and"," "),t.replace("+"," "),t.replace("-"," "),t.replace(","," "),t.replace("("," "),t.replace(")"," ");var r=t.indexOf("/");if(-1!=r){var n,a=t.lastIndexOf(" ",r),o=t.substring(r+1,t.length);-1!=a?n=t.substring(a+1,r):(n=t.substring(0,r),e=0);var s=parseFloat(n)/parseFloat(o);isNaN(s)||(e+=s)}}return e}function mod(t,e){return(t%e+e)%e}function run(){reset_display();var t=!1,e=$("#mode").val(),r=parse_compound_float($("#kerf").val()),n=[],a=[],o=[];if($sources.find("tbody tr").each(function(e,r){var o=parse_compound_float($(r).find(".length").val()),s=parseInt($(r).find(".quantity").val());if(isNaN(o))log_error("Source #"+e+": invalid length measurement"),t=!0;else if(isNaN(s))a.push({length:o});else for(var i=0;s>i;i++)n.push({length:o})}),$cuts.find("tbody tr").each(function(e,r){var n=parse_compound_float($(r).find(".length").val()),a=parseInt($(r).find(".quantity").val()),s=$(r).find(".color").css("background-color");if(isNaN(n))log_error("Cut #"+e+": invalid length measurement"),t=!0;else if(isNaN(a))log_error("Cut #"+e+": invalid quantity"),t=!0;else for(var i=0;a>i;i++)o.push({length:n,color:s})}),!t){var s=segmenter.run(e,r,n,a,o);s.success?display_results(s.data,r):log_error(s.data)}}function display_results(t,e){var r=canvas_width/largest_result(t);t.forEach(function(t){var n=add_result(),a=Math.round(t.length*r);n.find("h1").text(Math.round(100*t.length)/100);var o=n.find("canvas")[0].getContext("2d");o.fillStyle=canvas_bg,o.fillRect(0,0,a,canvas_height),o.font="normal 11pt Arial, sans-serif",o.textAlign="center",o.textBaseline="middle";var s=0;t.segments.forEach(function(n,a){var i=Math.round((n.length+e)*r);o.fillStyle=n.color,o.fillRect(s,0,i,canvas_height),o.fillStyle="#000",o.fillText(n.length,s+i/2,canvas_height/2),a!=t.segments.length-1&&o.fillRect(s+i-1,0,1,canvas_height),s+=i})}),$output.show()}function resize(){canvas_width=$output.width()-80,canvas_width=canvas_width>max_canvas_width?max_canvas_width:canvas_width}function largest_result(t){var e=0;return t.forEach(function(t){t.length>e&&(e=t.length)}),e}function add_result(){var t=$(" 	<li> 		<h1></h1> 		<canvas width='"+canvas_width+"' height='"+canvas_height+"'></canvas> 	</li>");return $output.append(t),t}function log_error(t){console.log(t),$errors.html($errors.html()+"<br>"+t),$errors.show()}function add_item(t){var e=t.find("tbody").children().last();t.append(e.clone(!0)),re_color()}function re_color(){$cuts.find("tbody tr").each(function(t,e){$(e).find(".color").css(color_for_index(t))})}function reset_display(){$welcome.hide(),$output.hide(),$output.empty(),$errors.empty()}var $sources,$cuts,$output,$errors,$welcome,canvas_width=800,canvas_height=20,canvas_bg="#888",max_canvas_width=800;$(function(){$sources=$("#sources"),$cuts=$("#cuts"),$output=$("#output"),$errors=$("#errors"),$welcome=$("#welcome"),$("#add-source").click(function(){add_item($sources)}),$("#add-cut").click(function(){add_item($cuts)}),$(".delete").on("click",function(){$(this).closest("tr").remove(),re_color()}),$("#run").click(run),re_color(),resize()});</script>

	</head>
	<body onunload=''>
		<aside>
			<button id="run">Run</button>

			<section>
				<h2>Settings</h2>

				<table id="settings">
					<tbody>
						<tr>
							<td>
								<select id="mode">
									<option value="auto" selected="selected">Auto</option>
									<option value="solve">Optimal (Slow)</option>
									<option value="fast_1">Suboptimal 1</option>
									<option value="fast_2">Suboptimal 2</option>
								</select>
							</td>
							<th>Mode</th>
						</tr>
						<tr>
							<td><input id="kerf" type="input" value="3/16"/></td> <!-- kerf -->
							<th>Saw&nbsp;Kerf</th>
						</tr>
					</tbody>
				</table>			

				<h2>Source Material<button id="add-source" class="add">+</button></h2>

				<table id="sources">
					<thead>
						<tr>
							<th>Length</th><th>Quantity</th><th></th>
						</tr>
					</thead>
					<tbody>
						<tr>
							<td><input class="length" type="input" required/></td>
							<td><input class="quantity" type="number" min="0" placeholder="unlimited"/></td>
							<td><button class="delete">X</button></td>
						</tr>
					</tbody>
				</table>

				<h2>Cuts<button id="add-cut" class="add">+</button></h2>

				<table id="cuts">
					<thead>
						<tr>
							<th></th><th>Length</th><th>Quantity</th><th></th>
						</tr>
					</thead>
					<tbody>
						<tr>
							<td><div class="color"></div></td>
							<td><input class="length" type="input" required/></td>
							<td><input class="quantity" type="number" min="0" value="1" required/></td>
							<td><button class="delete">X</button></td>
						</tr>
					</tbody>
				</table>

			</section>
		</aside>

		<div id="main">
			<ul id="output"></ul>
			<section id="errors"></section>
			<section id="welcome">
				<h1>Lumber Segmenter</h1>
				<p>
					Calculates cuts of lumber that minimize loss. Enter the length and quantity for your source lumber, and your desired cuts, and a cut pattern will be generated.
				</p>
				<p>
					If a source quantity is left blank, it will be treated as an unlimited resource. Fractional length measurements such as "34 1/2" are welcome. Units are irrelevant, as long as they're consistent.
				</p>
			</section>
		</div>
	</body>
</html>
